<?php
 require_once(dirname(__FILE__) . '/http.php'); class SimpleRealm { var $_type; var $_root; var $_username; var $_password; function SimpleRealm($type, $url) { $this->_type = $type; $this->_root = $url->getBasePath(); $this->_username = false; $this->_password = false; } function stretch($url) { $this->_root = $this->_getCommonPath($this->_root, $url->getPath()); } function _getCommonPath($first, $second) { $first = explode('/', $first); $second = explode('/', $second); for ($i = 0; $i < min(count($first), count($second)); $i++) { if ($first[$i] != $second[$i]) { return implode('/', array_slice($first, 0, $i)) . '/'; } } return implode('/', $first) . '/'; } function setIdentity($username, $password) { $this->_username = $username; $this->_password = $password; } function getUsername() { return $this->_username; } function getPassword() { return $this->_password; } function isWithin($url) { if ($this->_isIn($this->_root, $url->getBasePath())) { return true; } if ($this->_isIn($this->_root, $url->getBasePath() . $url->getPage() . '/')) { return true; } return false; } function _isIn($part, $whole) { return strpos($whole, $part) === 0; } } class SimpleAuthenticator { var $_realms; function SimpleAuthenticator() { $this->restartSession(); } function restartSession() { $this->_realms = array(); } function addRealm($url, $type, $realm) { $this->_realms[$url->getHost()][$realm] = new SimpleRealm($type, $url); } function setIdentityForRealm($host, $realm, $username, $password) { if (isset($this->_realms[$host][$realm])) { $this->_realms[$host][$realm]->setIdentity($username, $password); } } function _findRealmFromUrl($url) { if (! isset($this->_realms[$url->getHost()])) { return false; } foreach ($this->_realms[$url->getHost()] as $name => $realm) { if ($realm->isWithin($url)) { return $realm; } } return false; } function addHeaders(&$request, $url) { if ($url->getUsername() && $url->getPassword()) { $username = $url->getUsername(); $password = $url->getPassword(); } elseif ($realm = $this->_findRealmFromUrl($url)) { $username = $realm->getUsername(); $password = $realm->getPassword(); } else { return; } $this->addBasicHeaders($request, $username, $password); } function addBasicHeaders(&$request, $username, $password) { if ($username && $password) { $request->addHeaderLine( 'Authorization: Basic ' . base64_encode("$username:$password")); } } } ?>